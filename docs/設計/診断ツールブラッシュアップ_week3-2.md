# 診断ツールブラッシュアップ（week3-2）

## 概要
診断結果の精度・現実味を高めるため、質問の追加・AIプロンプトの改善・結果表示の拡張を実施。

## 変更対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `app/diagnosis/_data/questions.ts` | 質問3問追加 |
| `app/api/diagnosis/route.ts` | プロンプト改善 + JSONスキーマ拡張 + バグ修正 |
| `app/diagnosis/_components/DiagnosisResultView.tsx` | 新フィールド（年収レンジ・リスク分析）の表示追加 |
| `app/diagnosis/history/page.tsx` | ダッシュボードへの導線追加 |

---

## 1. 質問3問の追加（`questions.ts`）

q5（将来の働き方）の後、q6（自由記述）の前に以下の3問を挿入。

| ID | 質問 | タイプ | 選択肢 |
|----|------|--------|--------|
| q7 | 現在の年収に最も近いものを選んでください | single | 学生・未就業 / 300万円未満 / 300〜500万円 / 500〜700万円 / 700〜1000万円 / 1000万円以上 |
| q8 | 3年後に目指したい年収は？ | single | 400〜500万円 / 500〜700万円 / 700〜1000万円 / 1000〜1500万円 / 1500万円以上 |
| q9 | キャリアチェンジの時期感は？ | single | すぐにでも転職・転向したい（3ヶ月以内） / 半年以内に動きたい / 1〜2年かけて準備したい / 今すぐではないが情報収集中 / 現職を続けながら副業・スキルアップしたい |

---

## 2. プロンプト改善 + JSONスキーマ拡張（`route.ts`）

### 2-1. プロンプト指示の追加
以下の指示を【重要な指示】セクションに追加：
- 現在の年収と希望年収のギャップを踏まえた現実的な到達プラン提示
- おすすめ職種ごとに想定年収レンジを付記
- 転職緊急度に応じたロードマップのペース調整
- 各キャリアパスのリスクと対策を含める

### 2-2. JSONスキーマの変更

**`recommendations`**（変更）
- 旧: `string[]`（職種名のみ）
- 新: `{ jobTitle: string, salaryRange: string, fit: string }[]`（職種名 + 年収レンジ + 適合理由）

**`riskAnalysis`**（新規追加）
- キャリアパスのリスクと具体的な対策・回避策（200〜300文字）

### 2-3. バグ修正
- `max_tokens` を `2048` → `4096` に増加（スキーマ拡張によるレスポンス増大への対応）
- JSON抽出ロジックの強化
  - 閉じの ` ``` ` がない場合（トークン上限で途中切れ）にも対応する正規表現に変更
  - フォールバックとして最初の `{` から最後の `}` までを抽出する処理を追加

---

## 3. 結果表示の更新（`DiagnosisResultView.tsx`）

### 3-1. 型定義
- `RecommendationObj` 型を新規追加（`{ jobTitle, salaryRange, fit }`）
- `recommendations` を `string[] | RecommendationObj[]` のユニオン型に変更（後方互換）
- `riskAnalysis?: string` を追加

### 3-2. おすすめ職種セクション
- 新形式の場合：職種名（太字）+ 年収レンジ（サブテキスト）+ 適合理由で表示
- 旧形式（`string[]`）の場合：従来通りの表示（後方互換）

### 3-3. リスク分析セクション（新規）
- ギャップ分析の下に配置
- `WarningAmberIcon` 付きのカードで表示
- `riskAnalysis` がある場合のみ表示（後方互換）

---

## 4. 診断履歴ページ（`history/page.tsx`）

- 「新しい診断を始める」ボタンの下に「ダッシュボードに戻る」ボタンを追加
- `HomeIcon` 付きのアウトラインスタイルボタン

---

## 後方互換性
- 過去の診断結果（旧形式の `recommendations: string[]`、`riskAnalysis` なし）も正常に表示可能
- 型定義をユニオン型 + オプショナルで定義し、ランタイムで形式を判定して表示を切り替え
