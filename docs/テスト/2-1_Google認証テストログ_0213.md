# タスク2-1 Google認証による会員制機能 テストログ

## 実施日
2026/02/13

## 実施者
Claude Code + ユーザー（ブラウザ手動テスト）

---

## 1. テスト概要

タスク2-1で実装したGoogle OAuth認証機能の動作確認テストを実施。
前回（2/11）にcurlベースの自動テストで9/41項目を確認済み。
今回はブラウザでの手動テストにより、残りの項目を含めた実機確認を行った。

---

## 2. 発生した問題と対応

### 問題: Google認証後に「Server error - Configuration」が発生

**症状:**
- `/auth/signin` からGoogleログインボタンをクリック
- Google認証画面は正常に表示
- Googleアカウント選択・認証完了後、`/api/auth/error?error=Configuration` にリダイレクト
- 画面に「Server error - There is a problem with the server configuration.」と表示
- コンソールに `GET http://localhost:3000/api/auth/error?error=Configuration 500 (Internal Server Error)` のエラー

**原因調査:**
1. 認証設定ファイル（`auth.ts`, `auth.config.ts`, `middleware.ts`）のコードを確認 → 問題なし
2. NextAuth providers API（`/api/auth/providers`）を確認 → Google プロバイダー正常登録
3. **MongoDB接続テストを実施 → 認証エラー（`bad auth: authentication failed`）を検出**

**根本原因:**
- `.env.local` に設定されていたMongoDBのパスワードが無効になっていた
- NextAuth.jsの`MongoDBAdapter`がユーザー情報をDBに保存しようとして接続失敗
- NextAuth.jsが `error=Configuration` エラーを返していた

**対応内容:**

| # | 対応 | 詳細 |
|---|------|------|
| 1 | MongoDB Atlas確認 | ユーザー `masaharu3210101_db_user` の存在確認、パスワードリセット実施 |
| 2 | IPホワイトリスト確認 | 現在のIP `180.20.115.30` がAtlasの許可リストに含まれていることを確認 |
| 3 | `.env.local` 更新 | `MONGODB_URI` のパスワードを新パスワードに更新 |
| 4 | 接続テスト | Node.jsスクリプトでMongoDB接続成功を確認 |
| 5 | 開発サーバー再起動 | ポート3000でNext.js開発サーバーを再起動 |

---

## 3. テスト結果

### ブラウザ手動テスト（修正後）

| カテゴリ | 結果 | 備考 |
|---------|------|------|
| 1. ログインページ表示 | OK | `/auth/signin` 正常表示（前回curl確認済み含む） |
| 2. Googleログインボタン | OK | Google認証画面に正常遷移 |
| 3. ログイン成功後リダイレクト | OK | 認証完了後 `/dashboard` にリダイレクト |
| 4. ダッシュボード表示 | OK | タイトル「ダッシュボード」、アバター画像、名前「正相三井」、メール「masaharu3210101@gmail.com」、プロフィール設定リンク、ログアウトボタン すべて表示確認 |
| 5. プロフィールページ | 未確認 | 次回テストで確認予定 |
| 6. プロフィール編集 | 未確認 | 次回テストで確認予定 |
| 7. ログアウト機能 | OK | ログアウト後、LP（トップページ `/`）に正常遷移 |
| 8. 未ログイン時リダイレクト | OK | 前回curl確認済み（307リダイレクト） |
| 9. セッション維持 | 未確認 | 次回テストで確認予定 |

### 確認済みダッシュボード表示内容
- ユーザー名: 正相三井
- メールアドレス: masaharu3210101@gmail.com
- アバター画像: Googleアカウントのプロフィール画像が表示
- プロフィール設定リンク: 表示あり
- ログアウトボタン: 表示あり

---

## 4. 変更したファイル

| ファイル | 変更内容 |
|---------|---------|
| `.env.local` | `MONGODB_URI` のパスワードを新パスワードに更新 |

---

## 5. 残りのテスト項目

以下の項目はブラウザ手動確認が必要：

- [ ] プロフィールページの表示確認（`/profile`）
- [ ] プロフィール編集・保存の動作確認
- [ ] 名前空欄時の保存ボタン無効化確認
- [x] ログアウト後のリダイレクト確認 → LP（`/`）に正常遷移
- [ ] ログアウト後の保護ルートアクセス確認
- [ ] セッション維持（リロード、別タブ）確認

---

## 6. 本番環境（Vercel）テスト

### 6-1. 発生した問題と対応

#### 問題①: デプロイ後にGoogle認証で「サーバーエラー」が発生

**症状:**
- `https://myboard321.site/auth/signin` からGoogleログイン実行
- `https://myboard321.site/api/auth/error` に 500 エラーでリダイレクト
- Vercelログで全認証エンドポイント（`/api/auth/session`, `/api/auth/providers`, `/api/auth/callback/...`）が500エラー

**原因:**
- Vercelに環境変数が未設定だった

**対応:**
Vercel Environment Variables に以下を追加：

| 環境変数 | 値 |
|---------|---|
| `AUTH_SECRET` | （設定済み） |
| `AUTH_GOOGLE_ID` | （設定済み） |
| `AUTH_GOOGLE_SECRET` | （設定済み） |
| `MONGODB_URI` | （設定済み） |
| `AUTH_URL` | `https://myboard321.site` |

#### 問題②: 環境変数設定後も `redirect_uri_mismatch` エラー

**症状:**
- Google認証画面で「アクセスをブロック: このアプリのリクエストは無効です」
- エラー 400: `redirect_uri_mismatch`
- Vercelログで全認証エンドポイントが引き続き500エラー

**原因:**
- `AUTH_TRUST_HOST` が未設定のため、Vercelのプロキシ環境でAuth.jsがホスト名を正しく検出できなかった
- Google Cloud ConsoleのリダイレクトURIは正しく設定済み（`https://myboard321.site/api/auth/callback/google`）

**対応:**
Vercel Environment Variables に追加：

| 環境変数 | 値 |
|---------|---|
| `AUTH_TRUST_HOST` | `true` |

#### 問題③: gitリポジトリに機密情報が含まれていた

**症状:**
- `docs/設計/mongodbテスト0213` にMongoDBパスワードが平文で記載されていた

**対応:**
- パスワードをマスク処理してコミット＆プッシュ
- MongoDB Atlasでのパスワード再変更を推奨（git履歴に残るため）

### 6-2. 本番環境テスト結果

| カテゴリ | 結果 | 備考 |
|---------|------|------|
| Googleログイン | OK | `https://myboard321.site/auth/signin` から正常にログイン成功 |
| ダッシュボード表示 | OK | ユーザー名、メール、アバター画像が正常表示 |
| ログアウト | OK | ログアウト後、LP（`/`）に正常遷移 |

### 6-3. 本番環境の設定一覧（最終状態）

**Vercel Environment Variables（6項目）:**
- `AUTH_SECRET`
- `AUTH_GOOGLE_ID`
- `AUTH_GOOGLE_SECRET`
- `MONGODB_URI`
- `AUTH_URL` = `https://myboard321.site`
- `AUTH_TRUST_HOST` = `true`

**Google Cloud Console:**
- リダイレクトURI 1: `http://localhost:3000/api/auth/callback/google`（ローカル用）
- リダイレクトURI 2: `https://myboard321.site/api/auth/callback/google`（本番用）

**MongoDB Atlas:**
- Network Access: `0.0.0.0/0`（全IP許可）に変更済み

### 6-4. ビルド時の警告（対応不要）

```
⚠ 「middleware」ファイルの規約は非推奨です。代わりに「proxy」を使用してください。
```
- Next.js 16 で `middleware.ts` が非推奨になった警告
- 現時点では動作に影響なし。将来的に `proxy` への移行を検討

---

## 7. 残りのテスト項目

以下の項目はブラウザ手動確認が必要：

- [ ] プロフィールページの表示確認（`/profile`）
- [ ] プロフィール編集・保存の動作確認
- [ ] 名前空欄時の保存ボタン無効化確認
- [x] ログアウト後のリダイレクト確認 → LP（`/`）に正常遷移
- [ ] ログアウト後の保護ルートアクセス確認
- [ ] セッション維持（リロード、別タブ）確認

---

## 8. 追加実装・修正（2026/02/15）

### 8-1. LP追従ヘッダーの実装

LPにヘッダーが存在しなかったため、追従（fixed）ヘッダーを新規作成した。

**実装内容:**
- 左側: サイトロゴ（`/` へのリンク）
- 右側（PC）: 「新規登録/ログイン」（`/auth/signin`）、「無料診断を始める」（Coming Soon Snackbar）
- 右側（SP）: ハンバーガーメニュー内に上記リンクを格納（MUI Drawer使用）
- `position: fixed` で画面上部に固定（`globals.css` の `overflow-x: hidden` が `sticky` を無効化するため）

**変更ファイル:**

| ファイル | 操作 | 内容 |
|---------|------|------|
| `public/logo.png` | 新規 | ロゴ画像を配置 |
| `app/components/Header.tsx` | 新規作成 | 追従ヘッダーコンポーネント（PC: ボタン表示、SP: ハンバーガーメニュー） |
| `app/page.tsx` | 修正 | `<Header />` を `<HeroSection />` の上に追加 |

### 8-2. プロフィール更新が反映されないバグの修正

**症状:**
- プロフィール設定ページで名前を変更して保存
- 「プロフィールを更新しました」の成功メッセージは表示される
- しかしダッシュボードに戻ると名前が更新前のまま

**原因:**
- `auth.ts` の `jwt` コールバックで、クライアントから `update({ name })` が呼ばれた際（`trigger === "update"`）に JWT トークンの `name` を更新する処理がなかった
- DB への書き込みは成功していたが、セッション（JWT トークン）に反映されないため画面上は古い名前のまま

**対応:**

| ファイル | 変更内容 |
|---------|---------|
| `auth.ts` | `jwt` コールバック: `trigger === 'update'` 時に `token.name` を更新データで上書き |
| `auth.ts` | `session` コールバック: `token.name` を `session.user.name` に反映する処理を追加 |

---

## 9. 教訓・メモ

- NextAuth.jsの `error=Configuration` はDBアダプタの接続エラーが原因になりうる
- MongoDB Atlasのパスワード変更時は `.env.local` の更新と開発サーバー再起動が必要
- IPホワイトリストの確認も忘れずに行う
- Vercelデプロイ時は `AUTH_TRUST_HOST=true` が必須（プロキシ環境でのホスト検出に必要）
- Vercelでは環境変数の追加後に再デプロイが必要（自動反映されない）
- ドキュメントにパスワード等の機密情報を記載しない。記載する場合はマスク処理を行う
- gitの履歴に機密情報が残るため、漏洩時はパスワード再変更が必要
- `globals.css` で `overflow-x: hidden` を設定すると `position: sticky` が効かなくなる → `fixed` + スペーサーで対応
- NextAuth v5 の `useSession().update()` でセッションを更新するには、`jwt` コールバックで `trigger === 'update'` を処理する必要がある
