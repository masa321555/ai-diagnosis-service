# タスク2-1 Google認証による会員制機能 テストログ

## 実施日
2026/02/13

## 実施者
Claude Code + ユーザー（ブラウザ手動テスト）

---

## 1. テスト概要

タスク2-1で実装したGoogle OAuth認証機能の動作確認テストを実施。
前回（2/11）にcurlベースの自動テストで9/41項目を確認済み。
今回はブラウザでの手動テストにより、残りの項目を含めた実機確認を行った。

---

## 2. 発生した問題と対応

### 問題: Google認証後に「Server error - Configuration」が発生

**症状:**
- `/auth/signin` からGoogleログインボタンをクリック
- Google認証画面は正常に表示
- Googleアカウント選択・認証完了後、`/api/auth/error?error=Configuration` にリダイレクト
- 画面に「Server error - There is a problem with the server configuration.」と表示
- コンソールに `GET http://localhost:3000/api/auth/error?error=Configuration 500 (Internal Server Error)` のエラー

**原因調査:**
1. 認証設定ファイル（`auth.ts`, `auth.config.ts`, `middleware.ts`）のコードを確認 → 問題なし
2. NextAuth providers API（`/api/auth/providers`）を確認 → Google プロバイダー正常登録
3. **MongoDB接続テストを実施 → 認証エラー（`bad auth: authentication failed`）を検出**

**根本原因:**
- `.env.local` に設定されていたMongoDBのパスワードが無効になっていた
- NextAuth.jsの`MongoDBAdapter`がユーザー情報をDBに保存しようとして接続失敗
- NextAuth.jsが `error=Configuration` エラーを返していた

**対応内容:**

| # | 対応 | 詳細 |
|---|------|------|
| 1 | MongoDB Atlas確認 | ユーザー `masaharu3210101_db_user` の存在確認、パスワードリセット実施 |
| 2 | IPホワイトリスト確認 | 現在のIP `180.20.115.30` がAtlasの許可リストに含まれていることを確認 |
| 3 | `.env.local` 更新 | `MONGODB_URI` のパスワードを新パスワードに更新 |
| 4 | 接続テスト | Node.jsスクリプトでMongoDB接続成功を確認 |
| 5 | 開発サーバー再起動 | ポート3000でNext.js開発サーバーを再起動 |

---

## 3. テスト結果

### ブラウザ手動テスト（修正後）

| カテゴリ | 結果 | 備考 |
|---------|------|------|
| 1. ログインページ表示 | OK | `/auth/signin` 正常表示（前回curl確認済み含む） |
| 2. Googleログインボタン | OK | Google認証画面に正常遷移 |
| 3. ログイン成功後リダイレクト | OK | 認証完了後 `/dashboard` にリダイレクト |
| 4. ダッシュボード表示 | OK | タイトル「ダッシュボード」、アバター画像、名前「正相三井」、メール「masaharu3210101@gmail.com」、プロフィール設定リンク、ログアウトボタン すべて表示確認 |
| 5. プロフィールページ | 未確認 | 次回テストで確認予定 |
| 6. プロフィール編集 | 未確認 | 次回テストで確認予定 |
| 7. ログアウト機能 | OK | ログアウト後、LP（トップページ `/`）に正常遷移 |
| 8. 未ログイン時リダイレクト | OK | 前回curl確認済み（307リダイレクト） |
| 9. セッション維持 | 未確認 | 次回テストで確認予定 |

### 確認済みダッシュボード表示内容
- ユーザー名: 正相三井
- メールアドレス: masaharu3210101@gmail.com
- アバター画像: Googleアカウントのプロフィール画像が表示
- プロフィール設定リンク: 表示あり
- ログアウトボタン: 表示あり

---

## 4. 変更したファイル

| ファイル | 変更内容 |
|---------|---------|
| `.env.local` | `MONGODB_URI` のパスワードを新パスワードに更新 |

---

## 5. 残りのテスト項目

以下の項目はブラウザ手動確認が必要：

- [ ] プロフィールページの表示確認（`/profile`）
- [ ] プロフィール編集・保存の動作確認
- [ ] 名前空欄時の保存ボタン無効化確認
- [x] ログアウト後のリダイレクト確認 → LP（`/`）に正常遷移
- [ ] ログアウト後の保護ルートアクセス確認
- [ ] セッション維持（リロード、別タブ）確認

---

## 6. 教訓・メモ

- NextAuth.jsの `error=Configuration` はDBアダプタの接続エラーが原因になりうる
- MongoDB Atlasのパスワード変更時は `.env.local` の更新と開発サーバー再起動が必要
- IPホワイトリストの確認も忘れずに行う
